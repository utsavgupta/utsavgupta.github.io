<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leader election</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;700&display=swap" rel="stylesheet"> 
<link href="/css/fontawesome/css/all.min.css" rel="stylesheet">


    
    <link rel="stylesheet" href="https://utsavgupta.in/css/main.css">



    
    <link rel="stylesheet" href="https://utsavgupta.in/css/syntax-light.css">



    
    <link rel="stylesheet" href="https://utsavgupta.in/css/syntax-dark.css">

</head>
<body>
    <header>
        <a class="nav-logo-anchor" href="/"><div class="nav-logo"></div></a>
<div class="box-second-last"><a class="nav-link" href="/about">about</a></div>
<div class="box-last"><a class="nav-link" href="/tags">tags</a></div>
    </header>
    <main>
        
    <section class="main-content">
        <h1>Leader election</h1>
        <div class="post-meta">
            <i class="fa fa-calendar-alt"></i>&nbsp;Nov 11, 2020 | Written By Utsav Gupta
        </div>
        <div class="vspacer-1rem"></div>
        <!-- <p align="center">
    <img src="/img/leader-election.jpg" class="banner"> <br />
    <span>Photo by <a href="https://unsplash.com/@markusspiske?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Markus Spiske</a> on <a href="https://unsplash.com/s/photos/leader?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span>
</p> -->
<p>Recently all our services were replicated to multiple data centers on Google Cloud Platform. The REST API services scaled well without any code changes. However the batch jobs and their schedulers needed attention to ensure we avoid any kind of race conditions.</p>
<p>Leader election is ubiquitous in today&rsquo;s world of distributed computing. Knowingly or unknowingly we use a multitude of tools that make use of leader election to ensure systems run like clockwork. Cassandra and Kafka are two examples.</p>
<p>In this article will explore the idea, and one of its implementations in Go using Google Datastore for persisting data.</p>
<h2 id="what-is-leader-election-">What is leader election ?</h2>
<p>Before I answer that question, we need to understand how modern web applications and services are deployed. Much of the deployment strategy is decided by non functional requirements of the project. Requirements such as minimum availability and response times are taken into consideration for deciding the amount of redundancy and the location of the deployments. For example, if we want to make a service highly available, we would need to make replicas of it. So even if an instance dies, there would always be other instances available to carry out the same duties.</p>
<p>Making deployments redundant present us with another problem of ensuring that no two instances of the same job are performing the same piece of work at the same time. That of course does not imply that two instances cannot run at the same time, they shouldn&rsquo;t just get in each others way that will result in the system becoming inconsistent.</p>
<p>Enter leader election.</p>
<p><strong>It is the process of <em>electing</em> one of the replicas as the <em>leader</em> and letting it decide what to do, while the other replicas either remain idle or follow the leader</strong>. The decision depends on your use case. The leader may choose to perform a piece of task on its own, or it may decide to split the task into smaller chunks and distribute them to the other replicas.</p>
<h2 id="how-can-this-be-implemented-">How can this be implemented ?</h2>
<p>There are quite a few tools and techniques available for implementing leader election in your project. The one we explore here is based on an idea presented in this <a href="https://www.youtube.com/watch?v=fTCY93FsNko">video</a> (double thumbs up üëçüèΩüëçüèΩ to the folks at Microsoft for creating amazing documentation and training material). I quite liked this approach for its simplicity and the fact that it can work with any database system that features atomic operations.</p>
<h3 id="the-job">The job</h3>
<p>As a contrived example, let us create a job that preaches how cool Go is. Every time the job is scheduled it says something preachy about the language. However, in case we decided to scale up our preachers, we&rsquo;d like to ensure that we are not getting too preachy. That is to say that at any given point in time only one job gets to preach the message.</p>
<p>Our preacher is simple. It accepts a <em>StringWriter</em> as an argument and it preaches by writing the message to the string writer. Moreover since it is a preacher it likes to repeat the message, for which it accepts an integer indicating how many times the message should be printed.</p>
<p>We create a custom type, Job, which consists of a name and a doable (a function). In the next section we will create a scheduler which accepts a job that gets scheduled periodically.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Job</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Name</span> <span class="kt">string</span>
	<span class="nx">Do</span>   <span class="kd">func</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewPreacher</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">writer</span> <span class="nx">io</span><span class="p">.</span><span class="nx">StringWriter</span><span class="p">)</span> <span class="nx">Job</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">Job</span><span class="p">{</span>
		<span class="nx">Name</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
		<span class="nx">Do</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">times</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Printing the same message without any pause may alienate my audience.
</span><span class="c1"></span>            <span class="c1">// Thus I sleep for 1 second between each preaching.
</span><span class="c1"></span>
			<span class="c1">// Don&#39;t sleep before the first preaching
</span><span class="c1"></span>			<span class="nx">sleep</span> <span class="o">:=</span> <span class="kc">false</span>

			<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">times</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>

				<span class="k">if</span> <span class="nx">sleep</span> <span class="p">{</span>
					<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
				<span class="p">}</span>

				<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">writer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;Go is the best modern programming language\n&#34;</span><span class="p">)</span>

				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
				<span class="p">}</span>

				<span class="nx">sleep</span> <span class="p">=</span> <span class="kc">true</span>
			<span class="p">}</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="the-scheduler">The scheduler</h3>
<p>At the heart of our application is the scheduler. It is this component that on getting elected successfully schedules the job.</p>
<p>Before implementing the scheduling logic we need to create a data structure that would hold the lease information. <strong>In our case we can define a lease as a temporary right to schedule a job.</strong> It is important to understand that these leases need to be temporary to avoid a situation where a scheduler becomes the leader by getting the lease but eventually crashes. This would result in a deadlock wherein the previous leader is not available to work, yet other schedulers cannot become the new leader.</p>
<p>A lease can be uniquely identified by its job name, as there can be exactly one scheduler as the leader for a job. Thus, we can use the job name as a name key, and include only the leader name and expiry in the structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">lease</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Leader</span> <span class="kt">string</span>
	<span class="nx">Expiry</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>While creating a scheduler we need to assign it a name to be able to uniquely identify it in the election process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Scheduler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">jobs</span><span class="p">.</span><span class="nx">Job</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">NewScheduler</span><span class="p">(</span><span class="nx">nodeName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Client</span><span class="p">)</span> <span class="nx">Scheduler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">job</span> <span class="nx">jobs</span><span class="p">.</span><span class="nx">Job</span><span class="p">,</span> <span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
			<span class="k">if</span> <span class="nf">becomeLeader</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">job</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">job</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">// the preacher prints the message thrice
</span><span class="c1"></span>			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Finally we need to implement the <code>becomeLeader</code> function.</p>
<p>A scheduler can gain leadership in one of the following three scenarios</p>
<ul>
<li>There is no leader yet</li>
<li>The scheduler is already the leader</li>
<li>The lease of the previous leader has expired</li>
</ul>
<p>Reading and writing of lease entities need to be done in a transaction to ensure we avoid any race conditions. To guarantee atomicity of our database operations we make use of the client&rsquo;s <code>RunInTransaction</code> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">becomeLeader</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">jobName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">RunInTransaction</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">l</span> <span class="nx">lease</span>

		<span class="nx">key</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NameKey</span><span class="p">(</span><span class="s">&#34;Lease&#34;</span><span class="p">,</span> <span class="nx">jobName</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>

		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">l</span><span class="p">)</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nx">ErrNoSuchEntity</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="c1">// Become the leader only if an entry for the given job does not exist
</span><span class="c1"></span>		<span class="c1">// OR the lease of the previous leader has already expired
</span><span class="c1"></span>		<span class="c1">// OR the current scheduler was the previous leader
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">datastore</span><span class="p">.</span><span class="nx">ErrNoSuchEntity</span> <span class="o">||</span> <span class="nx">l</span><span class="p">.</span><span class="nx">Expiry</span><span class="p">.</span><span class="nf">Before</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">())</span> <span class="o">||</span> <span class="nx">l</span><span class="p">.</span><span class="nx">Leader</span> <span class="o">==</span> <span class="nx">nodeName</span> <span class="p">{</span>
			<span class="nx">l</span><span class="p">.</span><span class="nx">Leader</span> <span class="p">=</span> <span class="nx">nodeName</span>
			<span class="nx">l</span><span class="p">.</span><span class="nx">Expiry</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
			<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">l</span><span class="p">)</span>

			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Node %s could not become leader for job %s&#34;</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">jobName</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="k">return</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span>
	
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="putting-the-components-together">Putting the components together</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
<span class="nx">client</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">scheduler</span> <span class="o">:=</span> <span class="nf">NewScheduler</span><span class="p">(</span><span class="s">&#34;karmic-koala&#34;</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span>
<span class="nx">job</span> <span class="o">:=</span> <span class="nf">NewPreacher</span><span class="p">(</span><span class="s">&#34;go_preacher&#34;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">)</span>
<span class="nf">scheduler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">job</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span> <span class="c1">// schedule the job every minute
</span></code></pre></td></tr></table>
</div>
</div><p>You are encouraged to play around with the working example available at <a href="https://github.com/utsavgupta/go-leader-election">https://github.com/utsavgupta/go-leader-election</a>.</p>

    </section>
    <div id="progress-bar"></div>
    <div id="top-button" class="nav-link" onclick="javascript:window.scrollTo(0,0);"><i class="fa fa-chevron-up"></i></div>

    </main>
    <footer>
        <b>Utsav Gupta</b> ¬© 2021 Powered By <b>Hugo</b>. Hosted on <b>Github Pages</b>. <a href="/privacy" class="emph">Privacy Policy</a>.
    </footer>
    
<script src="/js/app.min.bdd6c648dfb03c40be1bd6a1a72fe2cc266bff6296119cdc24593f2eb4a6fb85b4127ff6342d74391f81ef1ac7e7a1822d23079707281cb66e319c48057f2f0f.js" integrity="sha512-vdbGSN&#43;wPEC&#43;G9ahpy/izCZr/2KWEZzcJFk/LrSm&#43;4W0En/2NC10OR&#43;B7xrH56GCLSMHlwcoHLZuMZxIBX8vDw=="></script>

</body>
</html>