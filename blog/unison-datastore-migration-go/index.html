<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unison: A Datastore migration library for Google Go</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;700&display=swap" rel="stylesheet"> 
<link href="/css/fontawesome/css/all.min.css" rel="stylesheet">


    
    <link rel="stylesheet" href="https://utsavgupta.in/css/main.css">



    
    <link rel="stylesheet" href="https://utsavgupta.in/css/syntax-light.css">



    
    <link rel="stylesheet" href="https://utsavgupta.in/css/syntax-dark.css">

</head>
<body>
    <header>
        <a class="nav-logo-anchor" href="/"><div class="nav-logo"></div></a>
<div class="box-second-last"><a class="nav-link" href="/about">about</a></div>
<div class="box-last"><a class="nav-link" href="/tags">tags</a></div>
    </header>
    <main>
        
    <section class="main-content">
        <h1>Unison: A Datastore migration library for Google Go</h1>
        <div class="post-meta">
            <i class="fa fa-calendar-alt"></i>&nbsp;Mar 17, 2020 | Written By Utsav Gupta
        </div>
        <div class="vspacer-1rem"></div>
        <p>Unison is a lightweight library that allows you to version and manage your Datastore migrations. In this blog article we will have a look at how you can install the Unison command line tool and get started migrating entities to Datastore.</p>
<p><em>Note: At the time of writing this article the library was not compatible with Google Firestore.</em></p>
<p><em>Before we begin, the article assumes that you have Google Go installed on your computer. In case you do not have it installed, <a href="https://golang.org/dl/">click here</a> to grab an installer for your operating system.</em></p>
<p>The go-unison project comprises two packages, viz, unison and unisoner. The first is the library that you will use to migrate your scripts, while the latter is a command line tool that lets you generate new migration scripts.</p>
<p>Let&rsquo;s start with creating a migration script that migrates some delicious fruits to Datastore. Run the following commands to set up your project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir goapp
$ <span class="nb">cd</span> goapp
goapp $ go mod init goapp
goapp $ go get cloud.google.com/go/datastore
goapp $ mkdir ent
goapp $ touch ent/fruit.go
goapp $ touch main.go
</code></pre></td></tr></table>
</div>
</div><p>The <code>ent/fruit.go</code> file should contain the serializable Datastore entity structure as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">ent</span>

<span class="kd">type</span> <span class="nx">Fruit</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>   <span class="kt">string</span> <span class="s">`datastore:&#34;id&#34;`</span>
    <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`datastore:&#34;Name&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s go ahead and install the unisoner command line tool and the unison library.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ go get github.com/utsavgupta/go-unison/unisoner
goapp $ go get github.com/utsavgupta/go-unison/unison
</code></pre></td></tr></table>
</div>
</div><p>We are now ready to create new migration files. When you execute the unisoner command it creates the following to bootstrap unison.</p>
<ul>
<li><em>Migration package</em>: A new package is created in the present working directory. By default the name of this package is migration. But this can be overridden by either setting the environment variable <code>unison_migration_package</code> or by passing <code>--migration_package &lt;pkg_name&gt;</code> while executing the command. Note: if values are received from both, environment variable and the command line param, the latter will be given precedence.</li>
<li><em>Unison migrations type</em>: A new type gets created within the above package. It is on this type new migrations will be defined. Finally an instance of this type needs to be passed to the unison library for it to work its magic.</li>
</ul>
<p>Now with the details out of the way let&rsquo;s create our first migration script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ unisoner --migration_package gcp
Filename <span class="o">[</span>.go extension is automatically appended<span class="o">]</span> <span class="o">(</span>default -&gt; Apply1584396052<span class="o">)</span>: fruits
Description: add fruits
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s examine the files that were generated by unison.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ ls gcp/
fruits.go   unison.go
</code></pre></td></tr></table>
</div>
</div><p>The file unison.go contains the migrations type that has been explained above. The other file is where the migration script goes.</p>
<p>Open <code>gcp/fruits.go</code> in a text editor and the contents should look like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gcp</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
<span class="p">)</span>

<span class="c1">// Apply1584396052 add fruits
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UnisonMigrations</span><span class="p">)</span> <span class="nf">Apply1584396052</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">ns</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Each migration file we generate should ideally contain one method defined on UnisonMigrations. These method names are based on the following naming convention <code>Apply&lt;Timestamp&gt;</code>. It is based on this timestamp that the unison library sorts the order of migrations. A migration once successfully commited <em>will not</em> be run again. Only migrations that have a timestamp greater than the last successully executed migration will be executed.</p>
<p>Since I love eating apples and mangoes, I will migrate these two fruits to Datastore. Let&rsquo;s make the following changes to <code>gcp/fruits.go</code> (you can use your favorites here ðŸ˜‰).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gcp</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;goapp/ent&#34;</span>

    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
<span class="p">)</span>

<span class="c1">// Apply1584396052 add fruits
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UnisonMigrations</span><span class="p">)</span> <span class="nf">Apply1584396052</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">ns</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="nx">fruits</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;apple&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Apple&#34;</span><span class="p">},</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;mango&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Mango&#34;</span><span class="p">},</span>
	<span class="p">}</span>

	<span class="nx">keys</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fruits</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">fruit</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fruits</span> <span class="p">{</span>
		<span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NameKey</span><span class="p">(</span><span class="s">&#34;Fruits&#34;</span><span class="p">,</span> <span class="nx">fruit</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	    <span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">Namespace</span> <span class="p">=</span> <span class="nx">ns</span>
	<span class="p">}</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">PutMulti</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">fruits</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Great! Our first migration script is ready. Now all that remains is to use the unison library to migrate this script. For that let&rsquo;s make changes to <code>main.go</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>

    <span class="s">&#34;goapp/gcp&#34;</span>

    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
    <span class="s">&#34;github.com/utsavgupta/go-unison/unison&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
	<span class="nx">namespace</span> <span class="p">=</span> <span class="s">&#34;unison-demo&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">dsClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;*detect-project-id*&#34;</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">unisonMigrations</span> <span class="nx">gcp</span><span class="p">.</span><span class="nx">UnisonMigrations</span>

	<span class="nx">unison</span><span class="p">.</span><span class="nf">RunMigrations</span><span class="p">(</span><span class="nx">dsClient</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">unisonMigrations</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We are a step away from migrating our first entities to Datastore. Before running the code make sure you have Google application credentials set. More on it <a href="https://cloud.google.com/docs/authentication/production">here</a>.</p>
<p>After you have set the variable you will be ready to run your shiny new migration script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">goapp $ go run .
Running Unison
Applying migration 1584477480 ... Done
We are done !!
</code></pre></td></tr></table>
</div>
</div><p>Yay ! We are done migrating our first migration script. Head over to the Google Cloud console to verify the changes.</p>
<p><img src="/img/unison-fruit-1.png" alt="Fruit entities on Datastore" title="Fruit entities on Datastore"></p>
<p>Note that the migration records themselves are stored as entites of kind <code>UnisonMigrationMeta</code>.</p>
<p><img src="/img/unison-migrations-1.png" alt="Migration entities" title="Migration entities"></p>
<p>Now with the first migration script done, let&rsquo;s create a new script to migrate a few more fruits.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">goapp $ unisoner --migration_package gcp
Filename <span class="o">[</span>.go extension is automatically appended<span class="o">]</span> <span class="o">(</span>default -&gt; Apply1584126043<span class="o">)</span>: more_fruits
Description: add more fruits
</code></pre></td></tr></table>
</div>
</div><p>Edit the newly created <code>gcp/more_fruits.go</code> file to migrate a few more fruits.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gcp</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;goapp/ent&#34;</span>

    <span class="s">&#34;cloud.google.com/go/datastore&#34;</span>
<span class="p">)</span>

<span class="c1">// Apply1584126043 add fruits
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UnisonMigrations</span><span class="p">)</span> <span class="nf">Apply1584126043</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">,</span> <span class="nx">ns</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="nx">fruits</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;banana&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Banana&#34;</span><span class="p">},</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;orange&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Orange&#34;</span><span class="p">},</span>
		<span class="nx">ent</span><span class="p">.</span><span class="nx">Fruit</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="s">&#34;watermelon&#34;</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Watermelon&#34;</span><span class="p">},</span>
	<span class="p">}</span>

	<span class="nx">keys</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">datastore</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fruits</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">fruit</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fruits</span> <span class="p">{</span>
		<span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="p">=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NameKey</span><span class="p">(</span><span class="s">&#34;Fruits&#34;</span><span class="p">,</span> <span class="nx">fruit</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	    <span class="nx">keys</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">Namespace</span> <span class="p">=</span> <span class="nx">ns</span>
	<span class="p">}</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">PutMulti</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">fruits</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Running <code>go run .</code> again should migrate only the new migration script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">goapp $ go run .
Running Unison
Applying migration 1584126043 ... Done
We are done !!
</code></pre></td></tr></table>
</div>
</div><p><em>Please note: The project is in it&rsquo;s early stages. Contributions in terms of bug reports, documentation, and testing are welcome. Do not hesitate to report issues or to raise pull requests.</em></p>

    </section>
    <div id="progress-bar"></div>

    </main>
    <footer>
        <b>Utsav Gupta</b> Â© 2021 Powered By <b>Hugo</b>. Hosted on <b>Github Pages</b>. <a href="/privacy" class="emph">Privacy Policy</a>.
    </footer>
    
<script src="/js/app.min.a34612972aec8bdaddec9d49fc714c354091a663f58a96a2d9e1112b98e0345856570c1202e3ba23de852276b5d7fd01b5b575ac2e1356d95453bd466a09c69e.js" integrity="sha512-o0YSlyrsi9rd7J1J/HFMNUCRpmP1ipai2eERK5jgNFhWVwwSAuO6I96FIna11/0BtbV1rC4TVtlUU71GagnGng=="></script>

</body>
</html>